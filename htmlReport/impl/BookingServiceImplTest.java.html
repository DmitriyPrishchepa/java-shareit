<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookingServiceImplTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in server Coverage Results</a> &gt; <a href="index.source.html" class="el_package">impl</a> &gt; <span class="el_source">BookingServiceImplTest.java</span></div><h1>BookingServiceImplTest.java</h1><pre class="source lang-java linenums">package impl;

import jakarta.persistence.EntityManager;
import jakarta.persistence.EntityNotFoundException;
import jakarta.persistence.TypedQuery;
import org.hamcrest.Matchers;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;
import org.mockito.junit.jupiter.MockitoSettings;
import org.mockito.quality.Strictness;
import ru.practicum.shareit.booking.BookingRepository;
import ru.practicum.shareit.booking.BookingService;
import ru.practicum.shareit.booking.BookingServiceImpl;
import ru.practicum.shareit.booking.dto.BookingDto;
import ru.practicum.shareit.booking.dto.BookingDtoToReturn;
import ru.practicum.shareit.booking.mapper.BookingMapper;
import ru.practicum.shareit.booking.model.Booking;
import ru.practicum.shareit.booking.util.BookingState;
import ru.practicum.shareit.booking.util.BookingStateSearchParams;
import ru.practicum.shareit.exception.exceptions.BookingValidationException;
import ru.practicum.shareit.exception.exceptions.ElementNotFoundException;
import ru.practicum.shareit.exception.exceptions.MissingParameterException;
import ru.practicum.shareit.exception.exceptions.WrongUserException;
import ru.practicum.shareit.item.ItemRepository;
import ru.practicum.shareit.item.ItemService;
import ru.practicum.shareit.item.dto.ItemDto;
import ru.practicum.shareit.item.model.Item;
import ru.practicum.shareit.user.UserRepository;
import ru.practicum.shareit.user.UserService;
import ru.practicum.shareit.user.dto.UserDto;
import ru.practicum.shareit.user.model.User;

import java.time.LocalDateTime;
import java.util.List;

import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.*;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
@MockitoSettings(strictness = Strictness.LENIENT)
<span class="fc" id="L50">public class BookingServiceImplTest {</span>

    @Mock
    UserRepository userRepository;

    @Mock
    ItemRepository itemRepository;

    @Mock
    BookingRepository bookingRepository;

    @Mock
    BookingMapper bookingMapper;

    @Mock
    UserService userService;

    @Mock
    ItemService itemService;

    @Mock
    BookingService bookingService;

    @InjectMocks
    BookingServiceImpl bookingServiceImpl;

    @Mock
    EntityManager entityManager;

    UserDto userDto;
    ItemDto itemDto;
    BookingDto bookingDto;
    User mockedUser;
    Item mockedItem;
    Booking mockedBooking;
    TypedQuery&lt;User&gt; mockUserQuery;
    TypedQuery&lt;Item&gt; mockItemQuery;
    TypedQuery&lt;Booking&gt; mockBookingQuery;
    BookingDtoToReturn returnedBookingDto;

    Booking checkBooking;
    BookingDtoToReturn checkBookingDtoToReturn;

    private BookingDtoToReturn mapToReturn(
            Long id,
            LocalDateTime start,
            LocalDateTime end,
            User booker,
            Item item,
            BookingState bookingState
    ) {
<span class="fc" id="L101">        BookingDtoToReturn dto = new BookingDtoToReturn();</span>
<span class="fc" id="L102">        dto.setId(id);</span>
<span class="fc" id="L103">        dto.setStart(start);</span>
<span class="fc" id="L104">        dto.setEnd(end);</span>
<span class="fc" id="L105">        dto.setBooker(booker);</span>
<span class="fc" id="L106">        dto.setItem(item);</span>
<span class="fc" id="L107">        dto.setStatus(bookingState);</span>
<span class="fc" id="L108">        return dto;</span>
    }

    @BeforeEach
    void setUp() {

<span class="fc" id="L114">        Mockito.reset(userRepository, itemRepository, bookingRepository, userService, itemService, bookingService);</span>

<span class="fc" id="L116">        userDto = new UserDto();</span>
<span class="fc" id="L117">        userDto.setName(&quot;user1&quot;);</span>
<span class="fc" id="L118">        userDto.setEmail(&quot;user1@mail.ru&quot;);</span>

<span class="fc" id="L120">        mockedUser = mock(User.class);</span>
<span class="fc" id="L121">        Mockito.when(mockedUser.getId()).thenReturn(1L);</span>
<span class="fc" id="L122">        Mockito.when(mockedUser.getName()).thenReturn(&quot;user1&quot;);</span>
<span class="fc" id="L123">        Mockito.when(mockedUser.getEmail()).thenReturn(&quot;user1@mail.ru&quot;);</span>

<span class="fc" id="L125">        mockUserQuery = mock(TypedQuery.class);</span>

<span class="fc" id="L127">        Mockito.when(userService.createUser(Mockito.any(UserDto.class)))</span>
<span class="fc" id="L128">                .thenReturn(userDto);</span>

<span class="fc" id="L130">        Mockito.when(mockUserQuery.setParameter(Mockito.anyString(), Mockito.anyString()))</span>
<span class="fc" id="L131">                .thenReturn(mockUserQuery);</span>

<span class="fc" id="L133">        Mockito.when(mockUserQuery</span>
<span class="fc" id="L134">                        .getSingleResult())</span>
<span class="fc" id="L135">                .thenReturn(mockedUser);</span>

<span class="fc" id="L137">        userService.createUser(userDto);</span>

        //--------------------------------------

<span class="fc" id="L141">        itemDto = new ItemDto();</span>
<span class="fc" id="L142">        itemDto.setName(&quot;item1&quot;);</span>
<span class="fc" id="L143">        itemDto.setDescription(&quot;item1Descr&quot;);</span>
<span class="fc" id="L144">        itemDto.setOwnerId(mockedUser.getId());</span>
<span class="fc" id="L145">        itemDto.setAvailable(true);</span>

<span class="fc" id="L147">        mockedItem = mock(Item.class);</span>
<span class="fc" id="L148">        Mockito.when(mockedItem.getName()).thenReturn(&quot;item1&quot;);</span>
<span class="fc" id="L149">        Mockito.when(mockedItem.getDescription()).thenReturn(&quot;item1Descr&quot;);</span>
<span class="fc" id="L150">        Mockito.when(mockedItem.getOwnerId()).thenReturn(1L);</span>
<span class="fc" id="L151">        Mockito.when(mockedItem.getAvailable()).thenReturn(true);</span>

<span class="fc" id="L153">        mockItemQuery = mock(TypedQuery.class);</span>

<span class="fc" id="L155">        Mockito.when(itemService.addItem(Mockito.anyLong(), Mockito.any(ItemDto.class)))</span>
<span class="fc" id="L156">                .thenReturn(itemDto);</span>

<span class="fc" id="L158">        Mockito.when(mockItemQuery.setParameter(Mockito.anyString(), Mockito.anyString()))</span>
<span class="fc" id="L159">                .thenReturn(mockItemQuery);</span>

<span class="fc" id="L161">        Mockito.when(mockItemQuery.getSingleResult())</span>
<span class="fc" id="L162">                .thenReturn(mockedItem);</span>

<span class="fc" id="L164">        itemService.addItem(mockedUser.getId(), itemDto);</span>

        //------------------------------------------

        //request

<span class="fc" id="L170">        bookingDto = new BookingDto();</span>
<span class="fc" id="L171">        bookingDto.setItemId(1L);</span>
<span class="fc" id="L172">        bookingDto.setStatus(BookingState.WAITING);</span>
<span class="fc" id="L173">        bookingDto.setStart(LocalDateTime.of(2024, 11, 11, 11, 11, 11));</span>
<span class="fc" id="L174">        bookingDto.setEnd(LocalDateTime.of(2024, 12, 12, 12, 12, 12));</span>

<span class="fc" id="L176">        mockedBooking = mock(Booking.class);</span>

<span class="fc" id="L178">        mockedBooking = mock(Booking.class);</span>
<span class="fc" id="L179">        Mockito.when(mockedBooking.getId()).thenReturn(1L);</span>
<span class="fc" id="L180">        Mockito.when(mockedBooking.getStart()).thenReturn(bookingDto.getStart());</span>
<span class="fc" id="L181">        Mockito.when(mockedBooking.getEnd()).thenReturn(bookingDto.getEnd());</span>
<span class="fc" id="L182">        Mockito.when(mockedBooking.getStatus()).thenReturn(bookingDto.getStatus());</span>
<span class="fc" id="L183">        Mockito.when(mockedBooking.getItem()).thenReturn(mockedItem);</span>
<span class="fc" id="L184">        Mockito.when(mockedBooking.getBooker()).thenReturn(mockedUser);</span>

<span class="fc" id="L186">        mockBookingQuery = mock(TypedQuery.class);</span>

<span class="fc" id="L188">        returnedBookingDto = new BookingDtoToReturn();</span>
<span class="fc" id="L189">        returnedBookingDto.setId(1L);</span>
<span class="fc" id="L190">        returnedBookingDto.setStart(bookingDto.getStart());</span>
<span class="fc" id="L191">        returnedBookingDto.setEnd(bookingDto.getEnd());</span>
<span class="fc" id="L192">        returnedBookingDto.setStatus(bookingDto.getStatus());</span>
<span class="fc" id="L193">        returnedBookingDto.setItem(mockedItem);</span>
<span class="fc" id="L194">        returnedBookingDto.setBooker(mockedUser);</span>

<span class="fc" id="L196">        Mockito.when(bookingService.createBooking(Mockito.eq(userDto.getId()), Mockito.eq(bookingDto)))</span>
<span class="fc" id="L197">                .thenReturn(returnedBookingDto);</span>

<span class="fc" id="L199">        Mockito.when(mockBookingQuery.setParameter(Mockito.anyString(), Mockito.anyString()))</span>
<span class="fc" id="L200">                .thenReturn(mockBookingQuery);</span>

<span class="fc" id="L202">        Mockito.when(mockBookingQuery.getSingleResult())</span>
<span class="fc" id="L203">                .thenReturn(mockedBooking);</span>

<span class="fc" id="L205">        Mockito.when(entityManager.createQuery(Mockito.anyString(), Mockito.eq(Booking.class)))</span>
<span class="fc" id="L206">                .thenReturn(mockBookingQuery);</span>

        //для проверки состояний

<span class="fc" id="L210">        checkBooking = new Booking();</span>
<span class="fc" id="L211">        checkBooking.setStart(LocalDateTime.of(2026, 1, 1, 0, 0));</span>
<span class="fc" id="L212">        checkBooking.setEnd(LocalDateTime.of(2027, 1, 2, 0, 0)); // Дата окончания должна быть в прошлом</span>
<span class="fc" id="L213">        checkBooking.setItem(mockedItem);</span>
<span class="fc" id="L214">        checkBooking.setBooker(mockedUser);</span>
<span class="fc" id="L215">        checkBooking.setStatus(BookingState.APPROVED);</span>

<span class="fc" id="L217">        checkBookingDtoToReturn = mapToReturn(</span>
<span class="fc" id="L218">                checkBooking.getId(),</span>
<span class="fc" id="L219">                checkBooking.getStart(),</span>
<span class="fc" id="L220">                checkBooking.getEnd(),</span>
<span class="fc" id="L221">                checkBooking.getBooker(),</span>
<span class="fc" id="L222">                checkBooking.getItem(),</span>
<span class="fc" id="L223">                checkBooking.getStatus()</span>
        );

        //инструкции
<span class="fc" id="L227">        Mockito.when(userRepository.existsById(Mockito.anyLong())).thenReturn(true);</span>
<span class="fc" id="L228">        Mockito.when(itemRepository.existsById(Mockito.anyLong())).thenReturn(false);</span>
<span class="fc" id="L229">    }</span>

    @Test
    void createBookingTest() {

<span class="fc" id="L234">        mockBookingQuery = entityManager.createQuery(&quot;select b from Booking b&quot;, Booking.class);</span>
<span class="fc" id="L235">        Booking booking = mockBookingQuery.getSingleResult();</span>

<span class="fc" id="L237">        assertThat(booking.getId(), notNullValue());</span>
<span class="fc" id="L238">        assertThat(booking.getStart(), equalTo(bookingDto.getStart()));</span>
<span class="fc" id="L239">        assertThat(booking.getStatus(), equalTo(bookingDto.getStatus()));</span>
<span class="fc" id="L240">    }</span>

    @Test
    void createBookingUserNotFoundTest() {
<span class="fc" id="L244">        Mockito.when(userRepository.existsById(Mockito.anyLong())).thenReturn(false);</span>

        try {
<span class="nc" id="L247">            bookingServiceImpl.createBooking(userDto.getId(), new BookingDto());</span>
<span class="fc" id="L248">        } catch (ElementNotFoundException e) {</span>
<span class="fc" id="L249">            assertEquals(&quot;User not found&quot;, e.getMessage());</span>
<span class="nc" id="L250">        }</span>
<span class="fc" id="L251">    }</span>

    @Test
    void createBookingItemNotFoundTest() {

        try {
<span class="nc" id="L257">            bookingServiceImpl.createBooking(1L, bookingDto);</span>
<span class="fc" id="L258">        } catch (ElementNotFoundException e) {</span>
<span class="fc" id="L259">            assertEquals(&quot;Item not found&quot;, e.getMessage());</span>
<span class="nc" id="L260">        }</span>
<span class="fc" id="L261">    }</span>

    @Test
    void createBookingItemNotAvailableTest() {
<span class="fc" id="L265">        Mockito.when(userRepository.existsById(Mockito.anyLong())).thenReturn(true);</span>
<span class="fc" id="L266">        Mockito.when(itemRepository.existsById(Mockito.anyLong())).thenReturn(true);</span>

<span class="fc" id="L268">        Mockito.when(mockedItem.getAvailable())</span>
<span class="fc" id="L269">                .thenReturn(false);</span>

<span class="fc" id="L271">        Mockito.when(itemRepository.getReferenceById(Mockito.anyLong())).thenReturn(mockedItem);</span>

<span class="fc" id="L273">        Mockito.when(bookingMapper.mapFromDto(Mockito.any(BookingDto.class)))</span>
<span class="fc" id="L274">                .thenReturn(mockedBooking);</span>

<span class="fc" id="L276">        Mockito.when(bookingRepository.save(Mockito.eq(mockedBooking)))</span>
<span class="fc" id="L277">                .thenReturn(mockedBooking);</span>
        try {
<span class="nc" id="L279">            bookingServiceImpl.createBooking(1L, bookingDto);</span>
<span class="fc" id="L280">        } catch (BookingValidationException e) {</span>
<span class="fc" id="L281">            assertEquals(&quot;Item not available&quot;, e.getMessage());</span>
<span class="nc" id="L282">        }</span>
<span class="fc" id="L283">    }</span>

    @Test
    void createBookingStartDateEqualsEndDateTest() {
<span class="fc" id="L287">        Mockito.when(userRepository.existsById(Mockito.anyLong())).thenReturn(true);</span>
<span class="fc" id="L288">        Mockito.when(userRepository.getReferenceById(Mockito.anyLong())).thenReturn(mockedUser);</span>
<span class="fc" id="L289">        Mockito.when(itemRepository.existsById(Mockito.anyLong())).thenReturn(true);</span>
<span class="fc" id="L290">        Mockito.when(itemRepository.getReferenceById(Mockito.anyLong())).thenReturn(mockedItem);</span>

<span class="fc" id="L292">        BookingDto bookingDto1 = new BookingDto();</span>
<span class="fc" id="L293">        bookingDto1.setItemId(1L);</span>
<span class="fc" id="L294">        bookingDto1.setStatus(BookingState.WAITING);</span>
<span class="fc" id="L295">        bookingDto1.setStart(LocalDateTime.of(2024, 11, 11, 11, 11, 11));</span>
<span class="fc" id="L296">        bookingDto1.setEnd(LocalDateTime.of(2024, 11, 11, 11, 11, 11));</span>

<span class="fc" id="L298">        Mockito.when(bookingMapper.mapFromDto(Mockito.any(BookingDto.class)))</span>
<span class="fc" id="L299">                .thenReturn(mockedBooking);</span>

<span class="fc" id="L301">        Mockito.when(bookingRepository.save(Mockito.eq(mockedBooking)))</span>
<span class="fc" id="L302">                .thenReturn(mockedBooking);</span>

        try {
<span class="nc" id="L305">            bookingServiceImpl.createBooking(1L, bookingDto1);</span>
<span class="fc" id="L306">        } catch (BookingValidationException e) {</span>
<span class="fc" id="L307">            assertEquals(&quot;Booking start date cannot be equals booking end date&quot;, e.getMessage());</span>
<span class="nc" id="L308">        }</span>
<span class="fc" id="L309">    }</span>

    @Test
    void createBookingStartDateNotEqualsEndDateTest() {
<span class="fc" id="L313">        Mockito.when(userRepository.existsById(Mockito.anyLong())).thenReturn(true);</span>
<span class="fc" id="L314">        Mockito.when(userRepository.getReferenceById(Mockito.anyLong())).thenReturn(mockedUser);</span>
<span class="fc" id="L315">        Mockito.when(itemRepository.existsById(Mockito.anyLong())).thenReturn(true);</span>
<span class="fc" id="L316">        Mockito.when(itemRepository.getReferenceById(Mockito.anyLong())).thenReturn(mockedItem);</span>

<span class="fc" id="L318">        BookingDto bookingDto1 = new BookingDto();</span>
<span class="fc" id="L319">        bookingDto1.setItemId(1L);</span>
<span class="fc" id="L320">        bookingDto1.setStatus(BookingState.WAITING);</span>
<span class="fc" id="L321">        bookingDto1.setStart(LocalDateTime.of(2024, 11, 11, 11, 11, 11));</span>
<span class="fc" id="L322">        bookingDto1.setEnd(LocalDateTime.of(2025, 11, 11, 11, 11, 11));</span>

<span class="fc" id="L324">        Mockito.when(bookingMapper.mapFromDto(Mockito.any(BookingDto.class)))</span>
<span class="fc" id="L325">                .thenReturn(mockedBooking);</span>

<span class="fc" id="L327">        Mockito.when(bookingRepository.save(Mockito.eq(mockedBooking)))</span>
<span class="fc" id="L328">                .thenReturn(mockedBooking);</span>

        try {
<span class="fc" id="L331">            BookingDtoToReturn returnedDto = bookingServiceImpl.createBooking(1L, bookingDto1);</span>
<span class="fc" id="L332">            assertNotNull(returnedDto);</span>
<span class="fc" id="L333">            assertEquals(mockedBooking.getId(), returnedDto.getId());</span>
<span class="fc" id="L334">            assertEquals(mockedBooking.getItem(), returnedDto.getItem());</span>
<span class="fc" id="L335">            assertEquals(mockedBooking.getBooker(), returnedDto.getBooker());</span>
<span class="fc" id="L336">            assertEquals(mockedBooking.getStart(), returnedDto.getStart());</span>
<span class="fc" id="L337">            assertEquals(mockedBooking.getEnd(), returnedDto.getEnd());</span>
<span class="fc" id="L338">            assertEquals(BookingState.WAITING, returnedDto.getStatus());</span>
<span class="nc" id="L339">        } catch (BookingValidationException e) {</span>
<span class="nc" id="L340">            assertEquals(&quot;Booking start date cannot be equals booking end date&quot;, e.getMessage());</span>
<span class="fc" id="L341">        }</span>
<span class="fc" id="L342">    }</span>

    @Test
    void updateBookingApprovalTest_ValidationException_isMissing() {
        try {
<span class="nc" id="L347">            bookingServiceImpl.updateBookingApproval(1L, null, true);</span>
<span class="fc" id="L348">        } catch (MissingParameterException e) {</span>
<span class="fc" id="L349">            assertEquals(&quot;booking id is missing&quot;, e.getMessage());</span>
<span class="nc" id="L350">        }</span>
<span class="fc" id="L351">    }</span>

    @Test
    void updateBookingApprovalTest_ValidationException_IllegalArgument() {
        try {
<span class="nc" id="L356">            bookingServiceImpl.updateBookingApproval(1L, &quot;abc1&quot;, true);</span>
<span class="fc" id="L357">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L358">            assertEquals(&quot;Invalid booking id: &quot; + &quot;abc1&quot;, e.getMessage());</span>
<span class="nc" id="L359">        }</span>
<span class="fc" id="L360">    }</span>

    @Test
    void updateBookingApproval_WrongUser() {

<span class="fc" id="L365">        Mockito.when(bookingServiceImpl.checkExitstingBooking(Mockito.anyLong()))</span>
<span class="fc" id="L366">                .thenReturn(mockedBooking);</span>

<span class="fc" id="L368">        Mockito.when(mockedBooking.getItem().getOwnerId())</span>
<span class="fc" id="L369">                .thenReturn(3L);</span>

        try {
<span class="nc" id="L372">            bookingServiceImpl.updateBookingApproval(1L, &quot;1&quot;, true);</span>
<span class="fc" id="L373">        } catch (WrongUserException e) {</span>
<span class="fc" id="L374">            assertEquals(&quot;You are not the owner of the item and cannot update the booking.&quot;, e.getMessage());</span>
<span class="nc" id="L375">        }</span>

<span class="fc" id="L377">        Mockito.when(mockedBooking.getItem().getOwnerId())</span>
<span class="fc" id="L378">                .thenReturn(1L);</span>
<span class="fc" id="L379">    }</span>

    @Test
    void updateBookingApprovalTest_Approved() {
<span class="fc" id="L383">        Mockito.when(mockedBooking.getStatus())</span>
<span class="fc" id="L384">                .thenReturn(BookingState.APPROVED);</span>

<span class="fc" id="L386">        Mockito.when(bookingServiceImpl.checkExitstingBooking(Mockito.eq(mockedBooking.getId())))</span>
<span class="fc" id="L387">                .thenReturn(mockedBooking);</span>

<span class="fc" id="L389">        Mockito.when(bookingRepository.save(Mockito.any(Booking.class)))</span>
<span class="fc" id="L390">                .thenReturn(mockedBooking);</span>

<span class="fc" id="L392">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.any(Booking.class)))</span>
<span class="fc" id="L393">                .thenReturn(returnedBookingDto);</span>

<span class="fc" id="L395">        BookingDtoToReturn resultDto = bookingServiceImpl.updateBookingApproval(1L, &quot;1&quot;, true);</span>

<span class="fc" id="L397">        assertEquals(BookingState.APPROVED, resultDto.getStatus());</span>
<span class="fc" id="L398">    }</span>

    @Test
    void updateBookingApprovalTest_REJECTED() {
<span class="fc" id="L402">        Mockito.when(mockedBooking.getStatus())</span>
<span class="fc" id="L403">                .thenReturn(BookingState.REJECTED);</span>

<span class="fc" id="L405">        Mockito.when(bookingServiceImpl.checkExitstingBooking(Mockito.eq(mockedBooking.getId())))</span>
<span class="fc" id="L406">                .thenReturn(mockedBooking);</span>

<span class="fc" id="L408">        Mockito.when(bookingRepository.save(Mockito.any(Booking.class)))</span>
<span class="fc" id="L409">                .thenReturn(mockedBooking);</span>

<span class="fc" id="L411">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.any(Booking.class)))</span>
<span class="fc" id="L412">                .thenReturn(returnedBookingDto);</span>

<span class="fc" id="L414">        BookingDtoToReturn resultDto = bookingServiceImpl.updateBookingApproval(1L, &quot;1&quot;, false);</span>

<span class="fc" id="L416">        assertEquals(BookingState.REJECTED, resultDto.getStatus());</span>
<span class="fc" id="L417">    }</span>

    @Test
    void findBookingById_NotExistedBooking() {
<span class="fc" id="L421">        Mockito.when(bookingRepository.getReferenceById(Mockito.anyLong()))</span>
<span class="fc" id="L422">                .thenThrow(EntityNotFoundException.class);</span>

        try {
<span class="nc" id="L425">            bookingServiceImpl.findBookingById(1L, 1L);</span>
<span class="fc" id="L426">        } catch (ElementNotFoundException e) {</span>
<span class="fc" id="L427">            assertEquals(&quot;Booking not found&quot;, e.getMessage());</span>
<span class="nc" id="L428">        }</span>
<span class="fc" id="L429">    }</span>

    @Test
    void getBookingInfo_OwnerAccess_Success() {

<span class="fc" id="L434">        Mockito.when(bookingServiceImpl.checkExitstingBooking(Mockito.anyLong())).thenReturn(mockedBooking);</span>

<span class="fc" id="L436">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.eq(mockedBooking))).thenReturn(returnedBookingDto);</span>

<span class="fc" id="L438">        BookingDtoToReturn resultDto = bookingServiceImpl.findBookingById(1L, 1L);</span>

<span class="fc" id="L440">        assertEquals(returnedBookingDto, resultDto);</span>
<span class="fc" id="L441">    }</span>

    @Test
    void getBookingInfo_BookerAccess_Success() {
<span class="fc" id="L445">        Mockito.when(bookingServiceImpl.checkExitstingBooking(Mockito.anyLong())).thenReturn(mockedBooking);</span>

<span class="fc" id="L447">        BookingDtoToReturn expectedDto = new BookingDtoToReturn();</span>
<span class="fc" id="L448">        Mockito.when(bookingMapper.mapToBookingDtoReturned(mockedBooking)).thenReturn(expectedDto);</span>

<span class="fc" id="L450">        BookingDtoToReturn resultDto = bookingServiceImpl.findBookingById(1L, 1L);</span>

<span class="fc" id="L452">        assertEquals(expectedDto, resultDto);</span>
<span class="fc" id="L453">    }</span>

    @Test
    void getBookingInfo_WrongUser_ThrowsWrongUserException() {

<span class="fc" id="L458">        Mockito.when(mockedBooking.getBooker().getId())</span>
<span class="fc" id="L459">                .thenReturn(2L);</span>

<span class="fc" id="L461">        Mockito.when(mockedBooking.getItem().getOwnerId())</span>
<span class="fc" id="L462">                .thenReturn(3L);</span>

<span class="fc" id="L464">        Mockito.when(bookingServiceImpl.checkExitstingBooking(Mockito.anyLong())).thenReturn(mockedBooking);</span>

        try {
<span class="nc" id="L467">            bookingServiceImpl.findBookingById(1L, 1L);</span>
<span class="fc" id="L468">        } catch (WrongUserException e) {</span>
<span class="fc" id="L469">            assertEquals(&quot;Only owner or booker can get information about booking&quot;, e.getMessage());</span>
<span class="nc" id="L470">        }</span>

<span class="fc" id="L472">        Mockito.when(mockedBooking.getBooker().getId())</span>
<span class="fc" id="L473">                .thenReturn(1L);</span>

<span class="fc" id="L475">        Mockito.when(mockedBooking.getItem().getId())</span>
<span class="fc" id="L476">                .thenReturn(1L);</span>
<span class="fc" id="L477">    }</span>

    @Test
    void findByBookerIdAndStateSortedPastTest() {

<span class="fc" id="L482">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.eq(checkBooking)))</span>
<span class="fc" id="L483">                .thenReturn(checkBookingDtoToReturn);</span>

<span class="fc" id="L485">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.anyList()))</span>
<span class="fc" id="L486">                .thenReturn(List.of(checkBookingDtoToReturn));</span>

<span class="fc" id="L488">        Mockito.when(bookingRepository.findPastBookingsByBookerId(</span>
<span class="fc" id="L489">                        Mockito.anyLong(), Mockito.any(LocalDateTime.class)))</span>
<span class="fc" id="L490">                .thenReturn(List.of(checkBooking));</span>

<span class="fc" id="L492">        List&lt;BookingDtoToReturn&gt; result =</span>
<span class="fc" id="L493">                bookingServiceImpl.findByBookerIdAndStateSorted(1L, BookingStateSearchParams.PAST);</span>

<span class="fc" id="L495">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L496">    }</span>

    @Test
    void findByBookerIdAndStateSortedFutureTest() {
<span class="fc" id="L500">        checkBooking.setStatus(BookingState.APPROVED);</span>

<span class="fc" id="L502">        checkBookingDtoToReturn = mapToReturn(</span>
<span class="fc" id="L503">                checkBooking.getId(),</span>
<span class="fc" id="L504">                checkBooking.getStart(),</span>
<span class="fc" id="L505">                checkBooking.getEnd(),</span>
<span class="fc" id="L506">                checkBooking.getBooker(),</span>
<span class="fc" id="L507">                checkBooking.getItem(),</span>
<span class="fc" id="L508">                checkBooking.getStatus()</span>
        );

<span class="fc" id="L511">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.eq(checkBooking)))</span>
<span class="fc" id="L512">                .thenReturn(checkBookingDtoToReturn);</span>

<span class="fc" id="L514">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.anyList()))</span>
<span class="fc" id="L515">                .thenReturn(List.of(checkBookingDtoToReturn));</span>

<span class="fc" id="L517">        Mockito.when(bookingRepository.findFutureBookingsByBookerId(</span>
<span class="fc" id="L518">                        Mockito.anyLong(), Mockito.any(LocalDateTime.class)))</span>
<span class="fc" id="L519">                .thenReturn(List.of(checkBooking));</span>

<span class="fc" id="L521">        List&lt;BookingDtoToReturn&gt; result =</span>
<span class="fc" id="L522">                bookingServiceImpl.findByBookerIdAndStateSorted(1L, BookingStateSearchParams.FUTURE);</span>

<span class="fc" id="L524">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L525">    }</span>

    @Test
    void findByBookerIdAndStateSortedCurrentTest() {
<span class="fc" id="L529">        checkBooking.setStatus(BookingState.APPROVED);</span>

<span class="fc" id="L531">        checkBookingDtoToReturn = mapToReturn(</span>
<span class="fc" id="L532">                checkBooking.getId(),</span>
<span class="fc" id="L533">                checkBooking.getStart(),</span>
<span class="fc" id="L534">                checkBooking.getEnd(),</span>
<span class="fc" id="L535">                checkBooking.getBooker(),</span>
<span class="fc" id="L536">                checkBooking.getItem(),</span>
<span class="fc" id="L537">                checkBooking.getStatus()</span>
        );

<span class="fc" id="L540">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.eq(checkBooking)))</span>
<span class="fc" id="L541">                .thenReturn(checkBookingDtoToReturn);</span>

<span class="fc" id="L543">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.anyList()))</span>
<span class="fc" id="L544">                .thenReturn(List.of(checkBookingDtoToReturn));</span>

<span class="fc" id="L546">        Mockito.when(bookingRepository.findCurrentBookingsByBookerId(</span>
<span class="fc" id="L547">                        Mockito.anyLong(), Mockito.any(LocalDateTime.class)))</span>
<span class="fc" id="L548">                .thenReturn(List.of(checkBooking));</span>

<span class="fc" id="L550">        List&lt;BookingDtoToReturn&gt; result =</span>
<span class="fc" id="L551">                bookingServiceImpl.findByBookerIdAndStateSorted(1L, BookingStateSearchParams.CURRENT);</span>

<span class="fc" id="L553">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L554">    }</span>

    @Test
    void findByBookerIdAndStateSortedWaitingTest() {
<span class="fc" id="L558">        checkBooking.setStatus(BookingState.WAITING);</span>

<span class="fc" id="L560">        checkBookingDtoToReturn = mapToReturn(</span>
<span class="fc" id="L561">                checkBooking.getId(),</span>
<span class="fc" id="L562">                checkBooking.getStart(),</span>
<span class="fc" id="L563">                checkBooking.getEnd(),</span>
<span class="fc" id="L564">                checkBooking.getBooker(),</span>
<span class="fc" id="L565">                checkBooking.getItem(),</span>
<span class="fc" id="L566">                checkBooking.getStatus()</span>
        );

<span class="fc" id="L569">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.eq(checkBooking)))</span>
<span class="fc" id="L570">                .thenReturn(checkBookingDtoToReturn);</span>

<span class="fc" id="L572">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.anyList()))</span>
<span class="fc" id="L573">                .thenReturn(List.of(checkBookingDtoToReturn));</span>

<span class="fc" id="L575">        Mockito.when(bookingRepository.findAllByBookerIdAndStatus(</span>
<span class="fc" id="L576">                        Mockito.anyLong(), Mockito.eq(BookingStateSearchParams.WAITING)))</span>
<span class="fc" id="L577">                .thenReturn(List.of(checkBooking));</span>

<span class="fc" id="L579">        List&lt;BookingDtoToReturn&gt; result =</span>
<span class="fc" id="L580">                bookingServiceImpl.findByBookerIdAndStateSorted(1L, BookingStateSearchParams.WAITING);</span>

<span class="fc" id="L582">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L583">    }</span>

    @Test
    void findByBookerIdAndStateSortedRejectedTest() {
<span class="fc" id="L587">        checkBooking.setStatus(BookingState.REJECTED);</span>

<span class="fc" id="L589">        checkBookingDtoToReturn = mapToReturn(</span>
<span class="fc" id="L590">                checkBooking.getId(),</span>
<span class="fc" id="L591">                checkBooking.getStart(),</span>
<span class="fc" id="L592">                checkBooking.getEnd(),</span>
<span class="fc" id="L593">                checkBooking.getBooker(),</span>
<span class="fc" id="L594">                checkBooking.getItem(),</span>
<span class="fc" id="L595">                checkBooking.getStatus()</span>
        );

<span class="fc" id="L598">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.eq(checkBooking)))</span>
<span class="fc" id="L599">                .thenReturn(checkBookingDtoToReturn);</span>

<span class="fc" id="L601">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.anyList()))</span>
<span class="fc" id="L602">                .thenReturn(List.of(checkBookingDtoToReturn));</span>

<span class="fc" id="L604">        Mockito.when(bookingRepository.findAllByBookerIdAndStatus(</span>
<span class="fc" id="L605">                        Mockito.anyLong(), Mockito.eq(BookingStateSearchParams.REJECTED)))</span>
<span class="fc" id="L606">                .thenReturn(List.of(checkBooking));</span>

<span class="fc" id="L608">        List&lt;BookingDtoToReturn&gt; result = bookingServiceImpl.findByBookerIdAndStateSorted(1L, BookingStateSearchParams.REJECTED);</span>

<span class="fc" id="L610">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L611">    }</span>

    @Test
    void findByBookerIdAndStateSortedDefaultTest() {
<span class="fc" id="L615">        checkBooking.setStatus(BookingState.WAITING);</span>

<span class="fc" id="L617">        checkBookingDtoToReturn = mapToReturn(</span>
<span class="fc" id="L618">                checkBooking.getId(),</span>
<span class="fc" id="L619">                checkBooking.getStart(),</span>
<span class="fc" id="L620">                checkBooking.getEnd(),</span>
<span class="fc" id="L621">                checkBooking.getBooker(),</span>
<span class="fc" id="L622">                checkBooking.getItem(),</span>
<span class="fc" id="L623">                checkBooking.getStatus()</span>
        );

<span class="fc" id="L626">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.eq(checkBooking)))</span>
<span class="fc" id="L627">                .thenReturn(checkBookingDtoToReturn);</span>

<span class="fc" id="L629">        Mockito.when(bookingMapper.mapToBookingDtoReturned(Mockito.anyList()))</span>
<span class="fc" id="L630">                .thenReturn(List.of(checkBookingDtoToReturn));</span>

<span class="fc" id="L632">        Mockito.when(bookingRepository.findAllByBookerId(Mockito.anyLong()))</span>
<span class="fc" id="L633">                .thenReturn(List.of(checkBooking));</span>

<span class="fc" id="L635">        List&lt;BookingDtoToReturn&gt; result = bookingServiceImpl.findByBookerIdAndStateSorted(1L, BookingStateSearchParams.ALL);</span>

<span class="fc" id="L637">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L638">    }</span>

    //----------------------------------------------

    @Test
    void findAllByBookingItemOwnerIdAndStatusTest_PAST() {

<span class="fc" id="L645">        when(mockedBooking.getEnd())</span>
<span class="fc" id="L646">                .thenReturn(LocalDateTime.of(2022, 12, 12, 12, 12, 12));</span>

<span class="fc" id="L648">        Mockito.when(bookingRepository.findPastBookingsByOwnerId(Mockito.anyLong(), Mockito.eq(LocalDateTime.now())))</span>
<span class="fc" id="L649">                .thenReturn(List.of(mockedBooking));</span>

<span class="fc" id="L651">        List&lt;BookingDto&gt; result =</span>
<span class="fc" id="L652">                bookingServiceImpl.findAllByBookingItemOwnerIdAndStatus(1L, BookingStateSearchParams.PAST);</span>

<span class="fc" id="L654">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L655">    }</span>

    @Test
    void findAllByBookingItemOwnerIdAndStatusTest_FUTURE() {

<span class="fc" id="L660">        when(mockedBooking.getStart())</span>
<span class="fc" id="L661">                .thenReturn(LocalDateTime.of(2026, 12, 12, 12, 12, 12));</span>

<span class="fc" id="L663">        when(mockedBooking.getEnd())</span>
<span class="fc" id="L664">                .thenReturn(null);</span>

<span class="fc" id="L666">        Mockito.when(bookingRepository.findFutureBookingsByOwnerId(Mockito.anyLong(), Mockito.eq(LocalDateTime.now())))</span>
<span class="fc" id="L667">                .thenReturn(List.of(mockedBooking));</span>

<span class="fc" id="L669">        List&lt;BookingDto&gt; result =</span>
<span class="fc" id="L670">                bookingServiceImpl.findAllByBookingItemOwnerIdAndStatus(1L, BookingStateSearchParams.FUTURE);</span>

<span class="fc" id="L672">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L673">    }</span>

    @Test
    void findAllByBookingItemOwnerIdAndStatusTest_CURRENT() {

<span class="fc" id="L678">        when(mockedBooking.getStart())</span>
<span class="fc" id="L679">                .thenReturn(LocalDateTime.of(2024, 12, 12, 12, 12, 12));</span>

<span class="fc" id="L681">        when(mockedBooking.getEnd())</span>
<span class="fc" id="L682">                .thenReturn(null);</span>

<span class="fc" id="L684">        Mockito.when(bookingRepository.findCurrentBookingsByOwnerId(Mockito.anyLong(), Mockito.eq(LocalDateTime.now())))</span>
<span class="fc" id="L685">                .thenReturn(List.of(mockedBooking));</span>

<span class="fc" id="L687">        List&lt;BookingDto&gt; result =</span>
<span class="fc" id="L688">                bookingServiceImpl.findAllByBookingItemOwnerIdAndStatus(1L, BookingStateSearchParams.CURRENT);</span>

<span class="fc" id="L690">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L691">    }</span>

    @Test
    void findAllByBookingItemOwnerIdAndStatusTest_WAITING() {

<span class="fc" id="L696">        when(mockedBooking.getStart())</span>
<span class="fc" id="L697">                .thenReturn(LocalDateTime.of(2024, 12, 12, 12, 12, 12));</span>

<span class="fc" id="L699">        when(mockedBooking.getEnd())</span>
<span class="fc" id="L700">                .thenReturn(null);</span>

<span class="fc" id="L702">        Mockito.when(bookingRepository.findAllByOwnerIdAndStatus(</span>
<span class="fc" id="L703">                        Mockito.anyLong(), Mockito.eq(BookingStateSearchParams.WAITING)))</span>
<span class="fc" id="L704">                .thenReturn(List.of(mockedBooking));</span>

<span class="fc" id="L706">        List&lt;BookingDto&gt; result =</span>
<span class="fc" id="L707">                bookingServiceImpl.findAllByBookingItemOwnerIdAndStatus(1L, BookingStateSearchParams.WAITING);</span>

<span class="fc" id="L709">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L710">    }</span>

    @Test
    void findAllByBookingItemOwnerIdAndStatusTest_REJECTED() {

<span class="fc" id="L715">        when(mockedBooking.getStart())</span>
<span class="fc" id="L716">                .thenReturn(LocalDateTime.of(2024, 12, 12, 12, 12, 12));</span>

<span class="fc" id="L718">        when(mockedBooking.getEnd())</span>
<span class="fc" id="L719">                .thenReturn(null);</span>

<span class="fc" id="L721">        Mockito.when(bookingRepository.findAllByOwnerIdAndStatus(</span>
<span class="fc" id="L722">                        Mockito.anyLong(), Mockito.eq(BookingStateSearchParams.REJECTED)))</span>
<span class="fc" id="L723">                .thenReturn(List.of(mockedBooking));</span>

<span class="fc" id="L725">        List&lt;BookingDto&gt; result =</span>
<span class="fc" id="L726">                bookingServiceImpl.findAllByBookingItemOwnerIdAndStatus(1L, BookingStateSearchParams.REJECTED);</span>

<span class="fc" id="L728">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L729">    }</span>

    @Test
    void findAllByBookingItemOwnerIdAndStatusTest_DEFAULT() {

<span class="fc" id="L734">        when(mockedBooking.getStart())</span>
<span class="fc" id="L735">                .thenReturn(LocalDateTime.of(2024, 12, 12, 12, 12, 12));</span>

<span class="fc" id="L737">        when(mockedBooking.getEnd())</span>
<span class="fc" id="L738">                .thenReturn(null);</span>

<span class="fc" id="L740">        Mockito.when(bookingRepository.findAllByItemOwnerId(</span>
<span class="fc" id="L741">                        Mockito.anyLong()))</span>
<span class="fc" id="L742">                .thenReturn(List.of(mockedBooking));</span>

<span class="fc" id="L744">        List&lt;BookingDto&gt; result =</span>
<span class="fc" id="L745">                bookingServiceImpl.findAllByBookingItemOwnerIdAndStatus(1L, BookingStateSearchParams.ALL);</span>

<span class="fc" id="L747">        assertThat(result, Matchers.not(empty()));</span>
<span class="fc" id="L748">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>